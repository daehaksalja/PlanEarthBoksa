// Visitor Dashboard Logic (Cloudflare Workers + GA4 Ïó∞Îèô Î≤ÑÏ†Ñ)
// - Îç∞Ïù¥ÌÑ∞ ÏõêÏ≤ú: https://planearth-ga.jmlee710000.workers.dev
// - ÏùºÎã® "Î∞©Î¨∏Ïûê" ÏßÄÌëúÎäî GA4 activeUsers ÏÇ¨Ïö©.
//   pageviews(=screenPageViews)Î°ú Î≥¥Í≥† Ïã∂ÏúºÎ©¥ fetchDailyData()Ïùò Îß§ÌïëÎßå Î∞îÍæ∏Î©¥ Îèº.

const BASE = 'https://planearth-ga.jmlee710000.workers.dev';

/* utils */
function formatDate(d){ return d.toISOString().slice(0,10); }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function avg(arr){ return arr.length? sum(arr)/arr.length : 0; }
function percentChange(a,b){ if(!b) return 0; return (a-b)/b*100; }
function classifyPct(p){ if (p > 10) return 'good'; if (p < -10) return 'bad'; return 'mid'; }

/* === API Ìò∏Ï∂ú Ìï®ÏàòÎì§ === */

/* (ÏòµÏÖò) Î™©ÏóÖ: API Ïã§Ìå®Ïãú Ìè¥Î∞± */
function generateMock(){
  const today = new Date();
  const data = [];
  for(let i=0;i<120;i++){
    const date = new Date(today); date.setDate(today.getDate()-i);
    const base = 180 + Math.sin(i/5)*40;
    const noise = Math.random()*60 - 30;
    const value = Math.max(10, Math.round(base + noise));
    data.push({ date: formatDate(date), count: value });
  }
  return data.reverse();
}

/* === Ïã§Ï†ú GA4 ÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ ===
   /ga/daily?days=120 -> {ok, rows: [{date, users, pageviews}, ...]}
   Ïó¨Í∏∞ÏÑú "Î∞©Î¨∏Ïûê" Ïπ¥Îìú/Ï∞®Ìä∏Îäî usersÎ°ú Îß§Ìïë */
async function fetchDailyData(days=120){
  try{
    const r = await fetch(`${BASE}/ga/daily?days=${days}`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    // üëá users(Î∞©Î¨∏Ïûê) Í∏∞Ï§ÄÏúºÎ°ú Îß§Ìïë. pageviews Ïì∞Í≥† Ïã∂ÏúºÎ©¥ row.pageviewsÎ°ú Î≥ÄÍ≤Ω.
    return (data.rows || []).map(row => ({
      date: row.date,
      count: Number(row.users || 0)
    }));
  }catch(e){
    console.warn('GA fetch failed, using mock:', e);
    return generateMock();
  }
}

/* ÎîîÎ∞îÏù¥Ïä§Î≥Ñ Îç∞Ïù¥ÌÑ∞ */
async function fetchDevicesData(){
  try{
    const r = await fetch(`${BASE}/ga/devices`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Devices fetch failed:', e);
    return [
      { device: 'mobile', users: 150 },
      { device: 'desktop', users: 120 },
      { device: 'tablet', users: 30 }
    ];
  }
}

/* Íµ≠Í∞ÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞ */
async function fetchCountriesData(){
  try{
    const r = await fetch(`${BASE}/ga/countries?limit=10`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Countries fetch failed:', e);
    return [
      { country: 'South Korea', users: 200 },
      { country: 'United States', users: 50 },
      { country: 'Japan', users: 30 }
    ];
  }
}

/* Î∏åÎùºÏö∞Ï†ÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞ */
async function fetchBrowsersData(){
  try{
    const r = await fetch(`${BASE}/ga/browsers`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Browsers fetch failed:', e);
    return [
      { browser: 'Chrome', users: 180 },
      { browser: 'Safari', users: 60 },
      { browser: 'Firefox', users: 40 }
    ];
  }
}

/* Ïã†Í∑ú vs Ïû¨Î∞©Î¨∏Ïûê Îç∞Ïù¥ÌÑ∞ */
async function fetchUserTypesData(){
  try{
    const r = await fetch(`${BASE}/ga/user-types`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data;
  }catch(e){
    console.warn('User types fetch failed:', e);
    return { newUsers: 150, returningUsers: 100, totalUsers: 250, newUserPercent: 60 };
  }
}

/* ÏãúÍ∞ÑÎåÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞ */
async function fetchHourlyData(){
  try{
    const r = await fetch(`${BASE}/ga/hourly`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Hourly fetch failed:', e);
    const mock = [];
    for(let h = 0; h < 24; h++){
      mock.push({ hour: h, users: Math.floor(Math.random() * 50) + 10 });
    }
    return mock;
  }
}

/* Ìä∏ÎûòÌîΩ ÏÜåÏä§ Îç∞Ïù¥ÌÑ∞ */
async function fetchTrafficSources(){
  try{
    const r = await fetch(`${BASE}/ga/sources?limit=10`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Traffic sources fetch failed:', e);
    return [
      { source: 'google / organic', users: 120, pageviews: 300 },
      { source: 'direct / (none)', users: 80, pageviews: 200 },
      { source: 'naver / organic', users: 40, pageviews: 100 }
    ];
  }
}

/* Ïù∏Í∏∞ ÌéòÏù¥ÏßÄ Îç∞Ïù¥ÌÑ∞ */
async function fetchPopularPages(){
  try{
    const r = await fetch(`${BASE}/ga/pages?limit=15`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data.rows || [];
  }catch(e){
    console.warn('Popular pages fetch failed:', e);
    return [
      { path: '/', views: 150 },
      { path: '/works.html', views: 80 },
      { path: '/workshop.html', views: 60 }
    ];
  }
}

/* ÏÑ±Îä• ÏßÄÌëú Îç∞Ïù¥ÌÑ∞ */
async function fetchPerformanceData(){
  try{
    const r = await fetch(`${BASE}/ga/performance`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'GA error');
    return data;
  }catch(e){
    console.warn('Performance fetch failed:', e);
    return { 
      avgSessionDuration: 180, 
      bounceRate: 65, 
      pagesPerSession: 2.3 
    };
  }
}

/* Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ */
async function fetchRealtimeData(){
  try{
    console.log('üî¥ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ï§ë...');
    const r = await fetch(`${BASE}/ga/realtime`, { cache: 'no-store', credentials: 'omit' });
    const data = await r.json();
    console.log('üî¥ Ïã§ÏãúÍ∞Ñ API ÏùëÎãµ:', data);
    
    if(!data.ok) throw new Error(data.error || 'GA error');
    
    const activeUsers = data.activeUsers || 0;
    console.log('üî¥ Ïã§ÏãúÍ∞Ñ ÌôúÏÑ± ÏÇ¨Ïö©Ïûê:', activeUsers);
    
    // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä 0Ïù¥Î©¥ ÌòÑÏû¨ Î∞©Î¨∏Ïûê ÏàòÎ•º 1Î°ú ÏÑ§Ï†ï (Î≥∏Ïù∏)
    return activeUsers > 0 ? activeUsers : 1;
  }catch(e){
    console.warn('Realtime fetch failed:', e);
    // Î≥∏Ïù∏Ïù¥ ÏßÄÍ∏à Ï†ëÏÜçÌï¥ ÏûàÏúºÎãà ÏµúÏÜå 1Î™Ö
    return 1;
  }
}

/* ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ */
function renderTable(rows){
  const tbody = document.querySelector('#rawTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  rows.forEach((r, i)=>{
    const tr = document.createElement('tr');
    const slice = rows.slice(Math.max(0, i-6), i+1); // Ìï¥ÎãπÏùº Ìè¨Ìï® 7Ïùº ÌèâÍ∑†
    const sevenAvg = avg(slice.map(s=>s.count));
    const ratio = sevenAvg ? ((r.count/sevenAvg)-1)*100 : 0;
    const cls = classifyPct(ratio);
    tr.innerHTML = `<td>${r.date}</td><td>${r.count}</td><td class="${cls}">${ratio.toFixed(1)}%</td>`;
    tbody.appendChild(tr);
  });
}

/* DOM Ìó¨Ìçº */
function setMetric(id,val){ const el=document.getElementById(id); if(el) el.textContent = val; }
function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent = val; }

/* Ï∞®Ìä∏ */
let chartDaily, chartWeekly, chartMonthly, chartDevices, chartBrowsers, chartUserTypes, chartHourly;

/* ÏÉàÎ°úÏö¥ Ï∞®Ìä∏ Î†åÎçîÎßÅ Ìï®ÏàòÎì§ */
function buildDevicesChart(ctx, devices){
  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: devices.map(d => d.device),
      datasets: [{
        data: devices.map(d => d.users),
        backgroundColor: ['#00ff9c', '#7fffd1', '#00ffc3'],
        borderColor: '#061e17',
        borderWidth: 2
      }]
    },
    options: {
      plugins: {
        legend: { 
          labels: { color: '#9fffe2' },
          position: 'bottom'
        }
      }
    }
  });
}

function renderCountriesList(countries) {
  const container = document.getElementById('countriesList');
  container.innerHTML = countries.slice(0, 8).map(country => `
    <div class="country-item">
      <span class="country-name">${country.country}</span>
      <span class="country-users">${country.users.toLocaleString()}</span>
    </div>
  `).join('');
}

function renderTrafficSources(sources) {
  const container = document.getElementById('trafficSources');
  container.innerHTML = sources.slice(0, 8).map(source => `
    <div class="source-item">
      <span class="source-name">${source.source}</span>
      <span class="source-users">${source.users.toLocaleString()}</span>
    </div>
  `).join('');
}

function renderPopularPages(pages) {
  const container = document.getElementById('popularPages');
  container.innerHTML = pages.slice(0, 10).map(page => `
    <div class="page-item">
      <span class="page-path">${page.path}</span>
      <span class="page-views">${page.views.toLocaleString()}</span>
    </div>
  `).join('');
}

function renderPerformanceMetrics(perf) {
  document.getElementById('avgSessionDuration').textContent = 
    perf.avgSessionDuration ? `${Math.floor(perf.avgSessionDuration / 60)}:${String(perf.avgSessionDuration % 60).padStart(2, '0')}` : '-';
  document.getElementById('bounceRate').textContent = 
    perf.bounceRate ? `${perf.bounceRate}%` : '-';
  document.getElementById('pagesPerSession').textContent = 
    perf.pagesPerSession || '-';
}

function buildBrowsersChart(ctx, browsers){
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: browsers.map(b => b.browser),
      datasets: [{
        label: 'Î∞©Î¨∏Ïûê',
        data: browsers.map(b => b.users),
        backgroundColor: '#00ff9c55',
        borderColor: '#00ff9c',
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: { ticks: { color: '#7fe4bf' }, grid: { color: '#0f3d2d' } },
        y: { ticks: { color: '#7fe4bf' }, grid: { display: false } }
      },
      plugins: { legend: { labels: { color: '#9fffe2' } } }
    }
  });
}

function buildUserTypesChart(ctx, userTypes){
  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Ïã†Í∑ú Î∞©Î¨∏Ïûê', 'Ïû¨Î∞©Î¨∏Ïûê'],
      datasets: [{
        data: [userTypes.newUsers, userTypes.returningUsers],
        backgroundColor: ['#00ff9c', '#7fffd1'],
        borderColor: '#061e17',
        borderWidth: 2
      }]
    },
    options: {
      plugins: {
        legend: { 
          labels: { color: '#9fffe2' },
          position: 'bottom'
        }
      }
    }
  });
}

function buildHourlyChart(ctx, hourly){
  // 24ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î≥¥Ïû•
  const hours = Array.from({length: 24}, (_, i) => {
    const found = hourly.find(h => h.hour === i);
    return found ? found.users : 0;
  });

  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}Ïãú`),
      datasets: [{
        label: 'ÏãúÍ∞ÑÎåÄÎ≥Ñ Î∞©Î¨∏Ïûê',
        data: hours,
        borderColor: '#00ff9c',
        backgroundColor: '#00ff9c22',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: '#7fe4bf' }, grid: { display: false } },
        y: { ticks: { color: '#7fe4bf' }, grid: { color: '#0f3d2d' } }
      },
      plugins: { legend: { labels: { color: '#9fffe2' } } }
    }
  });
}

function buildDailyChart(ctx, rows){
  const last = rows.slice(-14);
  return new Chart(ctx, {
    type:'bar',
    data:{
      labels:last.map(r=>r.date.slice(5)),
      datasets:[{
        label:'ÏùºÏùº Î∞©Î¨∏',
        data:last.map(r=>r.count),
        backgroundColor:'#00ff9c55',
        borderColor:'#00ff9c',
        borderWidth:1.5,
        borderRadius:4,
      }]
    },
    options:{
      scales:{
        x:{ ticks:{ color:'#7fe4bf' }, grid:{ display:false } },
        y:{ ticks:{ color:'#7fe4bf' }, grid:{ color:'#0f3d2d' } }
      },
      plugins:{ legend:{ labels:{ color:'#9fffe2' } } }
    }
  });
}

function buildWeeklyChart(ctx, rows){
  // Í∞ÑÎã®Ìûà Îí§ÏóêÏÑúÎ∂ÄÌÑ∞ 7Ïùº Î¨∂Ïùå
  const weeks=[]; let tmp=[];
  for(let i=0;i<rows.length;i++){
    tmp.push(rows[i]);
    if(tmp.length===7){ weeks.push(tmp); tmp=[]; }
  }
  if(tmp.length) weeks.push(tmp);
  const last12 = weeks.slice(-12);
  const labels = last12.map(w=> w[0].date.slice(5)+'~'+w[w.length-1].date.slice(5));
  const values = last12.map(w=> sum(w.map(r=>r.count)) );
  return new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Ï£ºÍ∞Ñ Ìï©Í≥Ñ',
        data:values,
        borderColor:'#00ffc3',
        backgroundColor:'#00ffc322',
        tension:.25,
        fill:true
      }]
    },
    options:{
      scales:{ x:{ ticks:{ color:'#7fe4bf' } }, y:{ ticks:{ color:'#7fe4bf' }, grid:{ color:'#0f3d2d' } } },
      plugins:{ legend:{ labels:{ color:'#9fffe2' } } }
    }
  });
}

function buildMonthlyChart(ctx, rows){
  const groups = {};
  rows.forEach(r=>{ const m=r.date.slice(0,7); groups[m]=(groups[m]||0)+r.count; });
  const months = Object.keys(groups).sort().slice(-12);
  const values = months.map(m=>groups[m]);
  return new Chart(ctx, {
    type:'bar',
    data:{
      labels:months.map(m=>m.slice(2)),
      datasets:[{
        label:'ÏõîÍ∞Ñ Ìï©Í≥Ñ',
        data:values,
        backgroundColor:'#009cffa8',
        borderColor:'#00aaff',
        borderWidth:1.5,
        borderRadius:3
      }]
    },
    options:{
      scales:{ x:{ ticks:{ color:'#7fe4bf' } }, y:{ ticks:{ color:'#7fe4bf' }, grid:{ color:'#0f3d2d' } } },
      plugins:{ legend:{ labels:{ color:'#9fffe2' } } }
    }
  });
}

/* ÏóîÌä∏Î¶¨ */
async function init(){
  // Î≥ëÎ†¨Î°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  const [rows, devices, countries, browsers, userTypes, hourly, sources, pages, performance, realtime] = await Promise.all([
    fetchDailyData(120),
    fetchDevicesData(),
    fetchCountriesData(),
    fetchBrowsersData(),
    fetchUserTypesData(),
    fetchHourlyData(),
    fetchTrafficSources(),
    fetchPopularPages(),
    fetchPerformanceData(),
    fetchRealtimeData()
  ]);

  if(!rows.length) return;

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞
  setMetric('realtimeCount', realtime.toLocaleString());

  // Ïπ¥Îìú ÏßÄÌëú
  const today = rows[rows.length-1] || {count:0};
  const yesterday = rows[rows.length-2] || {count:0};
  setMetric('todayCount', today.count.toLocaleString());
  setMetric('yesterdayCount', yesterday.count.toLocaleString());
  setText('todayChange', `${percentChange(today.count, yesterday.count).toFixed(1)}% vs Ïñ¥Ï†ú`);
  setText('yesterdayShare', (today.count? (yesterday.count/today.count*100):0).toFixed(1)+'% of Ïò§Îäò');

  const last7 = rows.slice(-7), last30 = rows.slice(-30);
  setMetric('weekCount', sum(last7.map(r=>r.count)).toLocaleString());
  setText('weekAvg', 'ÌèâÍ∑† '+Math.round(avg(last7.map(r=>r.count))).toLocaleString());
  setMetric('monthCount', sum(last30.map(r=>r.count)).toLocaleString());
  setText('monthAvg', 'ÌèâÍ∑† '+Math.round(avg(last30.map(r=>r.count))).toLocaleString());
  setMetric('totalCount', sum(rows.map(r=>r.count)).toLocaleString());
  setText('firstDate', rows[0].date+' ~ '+rows[rows.length-1].date);

  // ÏÑ±Îä• ÏßÄÌëú
  renderPerformanceMetrics(performance);
  // Ïã†Í∑ú Î∞©Î¨∏Ïûê ÎπÑÏú®ÎèÑ ÏÑ±Îä• ÏßÄÌëúÏóê Ï∂îÍ∞Ä
  document.getElementById('newUserPercent').textContent = userTypes.newUserPercent ? `${userTypes.newUserPercent}%` : '-';

  // ÌÖåÏù¥Î∏î & Í∏∞Ï°¥ Ï∞®Ìä∏
  renderTable(rows.slice(-90));
  chartDaily = buildDailyChart(document.getElementById('chartDaily'), rows);
  chartWeekly = buildWeeklyChart(document.getElementById('chartWeekly'), rows);
  chartMonthly = buildMonthlyChart(document.getElementById('chartMonthly'), rows);

  // ÏÉàÎ°úÏö¥ Î∂ÑÏÑù Ï∞®Ìä∏Îì§Í≥º Î¶¨Ïä§Ìä∏Îì§
  chartDevices = buildDevicesChart(document.getElementById('chartDevices'), devices);
  renderCountriesList(countries);
  renderTrafficSources(sources);
  renderPopularPages(pages);
  chartBrowsers = buildBrowsersChart(document.getElementById('chartBrowsers'), browsers);
  chartUserTypes = buildUserTypesChart(document.getElementById('chartUserTypes'), userTypes);
  chartHourly = buildHourlyChart(document.getElementById('chartHourly'), hourly);

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï£ºÍ∏∞Ï†Å ÏóÖÎç∞Ïù¥Ìä∏ (30Ï¥àÎßàÎã§)
  startRealtimeUpdates();
}

/* Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï£ºÍ∏∞Ï†Å ÏóÖÎç∞Ïù¥Ìä∏ */
function startRealtimeUpdates(){
  setInterval(async () => {
    try {
      const realtimeUsers = await fetchRealtimeData();
      setMetric('realtimeCount', realtimeUsers.toLocaleString());
      
      // Ïã§ÏãúÍ∞Ñ Ïπ¥ÎìúÏóê ÌéÑÏä§ Ìö®Í≥º Ï∂îÍ∞Ä
      const realtimeCard = document.getElementById('card-realtime');
      if(realtimeCard) {
        realtimeCard.style.transform = 'scale(1.02)';
        setTimeout(() => {
          realtimeCard.style.transform = 'scale(1)';
        }, 200);
      }
    } catch (e) {
      console.warn('Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', e);
    }
  }, 30000); // 30Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
}

init();
